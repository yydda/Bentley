# 功能修改与数据兼容性指南

## 📋 当前数据结构

### Firestore 数据结构
```
diaries/
  {userId}/
    dates/
      {date}/  (例如: "2024-01-15")
        - 时间花销: { ... }
        - LIFE: { ... }
        - AM: { ... }
        - LOVE: { ... }
        - date: "2024-01-15"
        - updatedAt: "2024-01-15T10:30:00.000Z"
```

### 数据字段结构
每个日期的数据包含以下模块：

#### 1. 时间花销
```javascript
{
  副业: 0,
  对象: 0,
  主职: 0,
  娱乐内耗: 0,
  通勤: 0,
  睡眠: 0,
  评分: ['💔', '💔', '💔', '💔', '💔'],
  评价: ''
}
```

#### 2. LIFE
```javascript
{
  坚持天数: 0,
  习惯: [],
  内耗: [],
  浪费时间点: '',
  反思与感悟: '',
  明日计划: {
    首要任务: ['', '', ''],
    待解决问题: ''
  }
}
```

#### 3. AM
```javascript
{
  项目进度: 0,
  时间追踪: 0,
  效率管理: 0,
  产出: '',
  反思与感悟: '',
  明日计划: {
    首要任务: ['', '', ''],
    待解决问题: ''
  }
}
```

#### 4. LOVE
```javascript
{
  新连接数: 0,
  有效互动量: 0,
  主动邀约次数: 0,
  记录: '',
  反思与感悟: '',
  明日计划: {
    首要任务: ['', '', ''],
    待解决问题: ''
  }
}
```

---

## ✅ 安全修改功能的方法

### 方法一：向后兼容（推荐）

**原则**：添加新字段，不删除旧字段

#### ✅ 可以做的修改

1. **添加新字段**
```javascript
// 在 getDefaultData() 中添加新字段
时间花销: {
  // ... 原有字段
  新字段: 0  // ✅ 新增字段
}
```

2. **添加可选字段**
```javascript
LIFE: {
  // ... 原有字段
  新标签: []  // ✅ 新增可选字段
}
```

3. **扩展数组字段**
```javascript
明日计划: {
  首要任务: ['', '', '', '']  // ✅ 从3个扩展到4个
}
```

#### ❌ 不要做的修改

1. **删除字段**（会导致旧数据丢失）
2. **重命名字段**（会导致旧数据无法读取）
3. **改变字段类型**（会导致数据错误）

---

## 🔧 修改步骤

### 步骤1：更新默认数据结构

修改 `src/utils/storage.js` 中的 `getDefaultData()` 函数：

```javascript
export function getDefaultData() {
  return {
    时间花销: {
      // ... 原有字段
      新字段: 0  // ✅ 添加新字段
    },
    // ... 其他模块
  }
}
```

### 步骤2：更新组件

修改对应的组件文件（如 `TimeSpend.vue`）：

```vue
<template>
  <!-- 添加新字段的输入框 -->
  <el-form-item label="新字段" label-width="100px">
    <el-input-number
      v-model="localData.新字段"
      :min="0"
      :max="24"
    />
  </el-form-item>
</template>
```

### 步骤3：数据兼容性处理

在组件初始化时，确保旧数据兼容：

```javascript
function initLocalData() {
  const defaultData = getDefaultData()
  const merged = {
    ...defaultData.时间花销,
    ...props.modelValue,
    // 确保新字段存在
    新字段: props.modelValue.新字段 ?? defaultData.时间花销.新字段
  }
  return merged
}
```

### 步骤4：更新导出功能

如果新字段需要导出，修改 `src/utils/export.js`：

```javascript
export function exportToMarkdown(date, data) {
  let markdown = `时间花销\n`
  markdown += `副业：${data.时间花销.副业}\n`
  markdown += `新字段：${data.时间花销.新字段}\n`  // ✅ 添加新字段导出
  // ...
}
```

---

## 🔄 数据迁移（如果需要）

### 场景：需要修改字段名或结构

如果必须修改字段名，需要编写数据迁移脚本：

#### 1. 创建迁移函数

```javascript
// src/utils/migration.js
export async function migrateData(userId) {
  const dates = await getAllDatesFromFirebase(userId)
  
  for (const date of dates) {
    const data = await getDiaryDataFromFirebase(userId, date)
    
    // 迁移逻辑
    if (data.旧字段名) {
      data.新字段名 = data.旧字段名
      delete data.旧字段名
    }
    
    // 保存迁移后的数据
    await saveDiaryDataToFirebase(userId, date, data)
  }
}
```

#### 2. 在登录后执行迁移

```javascript
// src/components/Login.vue
onMounted(async () => {
  // 检查是否需要迁移
  const needsMigration = checkMigrationNeeded()
  if (needsMigration && user.value) {
    await migrateData(user.value.uid)
  }
})
```

---

## 📝 常见修改场景

### 场景1：添加新的时间分类

**修改位置**：
- `src/utils/storage.js` - `getDefaultData()`
- `src/components/TimeSpend.vue` - 添加输入框

**数据影响**：
- ✅ 旧数据不受影响（新字段默认为0）
- ✅ 新数据包含新字段

### 场景2：修改评分系统

**修改位置**：
- `src/utils/storage.js` - `getDefaultData()` 中的评分数组
- `src/components/TimeSpend.vue` - 评分显示逻辑

**数据影响**：
- ⚠️ 如果改变评分数量，需要处理旧数据
- ✅ 建议保持5个评分不变，只修改显示方式

### 场景3：添加新的模块

**修改位置**：
- `src/utils/storage.js` - `getDefaultData()` 添加新模块
- `src/components/` - 创建新组件
- `src/views/Home.vue` - 添加新步骤

**数据影响**：
- ✅ 旧数据不受影响（新模块默认为空）
- ✅ 新数据包含新模块

### 场景4：修改表单布局

**修改位置**：
- `src/components/*.vue` - 修改模板和样式

**数据影响**：
- ✅ 不影响数据（只改变显示方式）

---

## 🛡️ 数据安全建议

### 1. 备份数据
修改前，建议先导出所有数据：
```javascript
// 在浏览器控制台执行
const dates = await getAllDates()
dates.forEach(async (date) => {
  const data = await getDiaryData(date)
  // 导出为JSON
  console.log(date, JSON.stringify(data))
})
```

### 2. 测试环境
- 先在本地测试
- 确认数据兼容性
- 再部署到生产环境

### 3. 版本标记
可以在数据中添加版本号：
```javascript
{
  version: '1.0.0',  // 数据版本
  时间花销: { ... },
  // ...
}
```

---

## 📚 修改示例

### 示例1：添加"运动"时间分类

**步骤1**：修改 `src/utils/storage.js`
```javascript
时间花销: {
  副业: 0,
  对象: 0,
  主职: 0,
  娱乐内耗: 0,
  通勤: 0,
  睡眠: 0,
  运动: 0,  // ✅ 新增
  评分: ['💔', '💔', '💔', '💔', '💔'],
  评价: ''
}
```

**步骤2**：修改 `src/components/TimeSpend.vue`
```vue
<el-form-item label="运动" label-width="100px">
  <div class="flex items-center gap-2 w-full">
    <el-input-number
      v-model="localData.运动"
      :min="0"
      :max="24"
      :precision="1"
      :step="0.5"
      controls-position="right"
      class="flex-1"
      placeholder="0"
    />
    <span class="unit-text min-w-[32px]">小时</span>
  </div>
</el-form-item>
```

**步骤3**：更新时间总和计算
```javascript
const totalHours = computed(() => {
  return (localData.value.副业 || 0) +
         (localData.value.对象 || 0) +
         (localData.value.主职 || 0) +
         (localData.value.娱乐内耗 || 0) +
         (localData.value.通勤 || 0) +
         (localData.value.睡眠 || 0) +
         (localData.value.运动 || 0)  // ✅ 添加
})
```

**数据影响**：
- ✅ 旧数据自动兼容（运动字段为0）
- ✅ 新数据包含运动字段

---

## ⚠️ 注意事项

### 1. 字段名修改
如果必须修改字段名，需要：
- 编写迁移脚本
- 批量更新所有旧数据
- 确保数据不丢失

### 2. 字段类型修改
如果必须修改字段类型：
- 先备份数据
- 编写转换逻辑
- 测试转换结果

### 3. 删除字段
**强烈不推荐**删除字段：
- 旧数据会丢失该字段
- 可能导致错误
- 建议标记为"已废弃"而不是删除

---

## 🔍 检查数据兼容性

### 方法1：在组件中检查
```javascript
function initLocalData() {
  const defaultData = getDefaultData()
  const merged = {
    ...defaultData.时间花销,
    ...props.modelValue,
    // 确保所有必需字段存在
    新字段: props.modelValue.新字段 ?? defaultData.时间花销.新字段
  }
  return merged
}
```

### 方法2：添加数据验证
```javascript
function validateData(data) {
  const defaultData = getDefaultData()
  const validated = {}
  
  // 确保所有字段都存在
  Object.keys(defaultData.时间花销).forEach(key => {
    validated[key] = data[key] ?? defaultData.时间花销[key]
  })
  
  return validated
}
```

---

## 📖 总结

### ✅ 安全修改（不影响旧数据）
1. 添加新字段
2. 添加可选字段
3. 扩展数组长度
4. 修改UI布局
5. 添加新模块

### ⚠️ 需要迁移的修改
1. 重命名字段
2. 改变字段类型
3. 删除字段
4. 改变数据结构

### 🎯 最佳实践
1. **向后兼容**：新功能不影响旧数据
2. **默认值**：为新字段提供合理的默认值
3. **数据验证**：确保数据完整性
4. **测试**：修改前先测试

---

## 🆘 遇到问题？

如果修改后数据出现问题：
1. 检查 `getDefaultData()` 是否包含所有必需字段
2. 检查组件初始化逻辑是否正确合并数据
3. 查看浏览器控制台错误信息
4. 检查 Firestore 控制台的数据结构

**记住**：只要遵循"向后兼容"原则，旧数据就不会受影响！

