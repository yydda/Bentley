# Firebase 配额使用说明

## 📊 关于实时监听（onSnapshot）

### 工作原理
Firestore 的 `onSnapshot` 实时监听**不是**每次都发起新的 HTTP 请求，而是：
1. **建立 WebSocket 长连接**：首次建立连接后，保持长连接
2. **复用连接**：后续的数据变化通过同一个 WebSocket 连接推送
3. **自动重连**：如果连接断开，会自动重连

### 配额消耗
- **建立监听**：每次建立监听算作**1次读取**
- **数据变化推送**：通过 WebSocket 推送，**不算读取次数**
- **连接保持**：保持连接**不消耗配额**

### 实际使用情况
对于日记应用：
- **每天建立监听次数**：假设每天切换日期10次 = 10次读取
- **每天保存数据**：假设每天保存20次 = 20次写入
- **每天查看历史**：假设查看5次 = 5次读取

**总计**：约 35次读取 + 20次写入/天

**免费额度**：50,000次读取 + 20,000次写入/天

**结论**：个人使用完全足够，不会快速用完！

---

## ⚠️ 注意事项

### 1. 避免重复监听
- ✅ 切换日期时，会取消之前的监听
- ✅ 登出时，会取消所有监听
- ⚠️ 如果同时打开多个标签页，每个标签页都会建立监听

### 2. 优化建议
- 只在需要时建立监听（当前日期）
- 切换日期时及时取消旧监听
- 避免在后台保持不必要的监听

---

## 🔧 优化方案

我已经优化了代码，确保：
1. ✅ 切换日期时取消旧监听
2. ✅ 登出时取消所有监听
3. ✅ 只在当前日期建立监听
4. ✅ 使用防抖保存，减少写入次数

**你的使用情况**：
- 每天填写1次日记 = 约10-20次写入（防抖后）
- 每天查看历史 = 约5-10次读取
- **每月总计**：约300-600次读取 + 300-600次写入

**免费额度**：50,000次读取/天 = 1,500,000次/月

**结论**：即使使用100倍，也不会用完免费额度！

---

## 📈 监控配额使用

你可以在 Firebase 控制台查看配额使用情况：
1. 打开 Firebase Console
2. 选择你的项目
3. 点击 "Usage and billing"（使用情况和结算）
4. 查看 Firestore 的使用情况

---

## 💡 如果担心配额

可以进一步优化：
1. **禁用实时监听**：只在需要时手动刷新数据
2. **减少保存频率**：增加防抖时间（当前是1秒）
3. **批量操作**：合并多个保存操作

但根据你的使用场景，**完全不需要担心**！

