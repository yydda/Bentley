# 数据保存问题排查指南

## 问题：数据没有保存到服务器

### 排查步骤

#### 1. 检查用户登录状态

打开浏览器控制台（F12），查看是否有以下日志：
- `初始化时用户状态: 已登录 (xxx)` 或 `未登录`
- `认证状态变化: 已登录` 或 `未登录`

**如果显示"未登录"**：
- 点击右上角的"登录"按钮
- 使用Google账号登录
- 登录成功后，应该看到 `用户登录成功: xxx` 的日志

#### 2. 检查数据保存日志

在控制台中查找以下日志：
- `开始保存数据到服务器...` - 表示开始保存
- `数据保存到Firebase成功` - 表示保存成功
- `保存数据失败:` - 表示保存失败，会显示错误信息

**如果没有看到保存日志**：
- 检查是否填写了数据
- 检查 `editingDate` 是否有效（应该显示当前日期）

#### 3. 检查Firebase配置

打开 `src/config/firebase.js`，确认：
- `apiKey` 是否正确
- `authDomain` 是否正确
- `projectId` 是否正确
- `storageBucket` 是否正确
- `messagingSenderId` 是否正确
- `appId` 是否正确

#### 4. 检查Firestore权限

在Firebase控制台：
1. 进入 **Firestore Database**
2. 点击 **规则** 标签
3. 确认规则允许当前用户读写：

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /diaries/{userId}/dates/{date} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

#### 5. 手动测试保存

1. 填写一些数据
2. 点击右上角的"保存"按钮
3. 查看控制台日志：
   - 应该看到 `手动保存数据到服务器...`
   - 应该看到 `手动保存成功`
   - 如果失败，会显示错误信息

#### 6. 检查网络请求

在浏览器开发者工具的 **Network** 标签中：
1. 过滤 `firestore.googleapis.com`
2. 点击"保存"按钮
3. 查看是否有 `Write` 请求
4. 如果有请求但失败，查看响应内容

### 常见错误及解决方案

#### 错误1：`请先登录以保存数据`
**原因**：用户未登录
**解决**：点击"登录"按钮，使用Google账号登录

#### 错误2：`日期不能为空`
**原因**：`editingDate` 未初始化
**解决**：刷新页面，确保 `editingDate` 正确初始化

#### 错误3：`Permission denied`
**原因**：Firestore权限规则不允许
**解决**：检查并更新Firestore安全规则（见步骤4）

#### 错误4：`Missing or insufficient permissions`
**原因**：Firestore权限不足
**解决**：
1. 检查Firestore规则
2. 确认用户已登录
3. 确认用户ID匹配

### 调试命令

在浏览器控制台中运行以下命令来检查状态：

```javascript
// 检查当前用户
console.log('当前用户:', window.__currentUser || '未设置')

// 检查formData
console.log('formData:', JSON.stringify(window.__formData || {}, null, 2))

// 检查editingDate
console.log('editingDate:', window.__editingDate || '未设置')

// 手动触发保存（如果已登录）
// 注意：这需要根据实际代码调整
```

### 临时解决方案

如果问题持续存在，可以：

1. **清除浏览器缓存和localStorage**
   ```javascript
   localStorage.clear()
   location.reload()
   ```

2. **检查Firebase项目状态**
   - 确认项目未暂停
   - 确认配额未超限
   - 确认账单正常

3. **重新配置Firebase**
   - 重新创建Firebase项目
   - 更新 `src/config/firebase.js` 中的配置
   - 重新设置Firestore规则

### 联系支持

如果以上步骤都无法解决问题，请提供：
1. 浏览器控制台的完整错误日志
2. Network标签中的Firestore请求详情
3. Firebase项目ID（不包含敏感信息）

